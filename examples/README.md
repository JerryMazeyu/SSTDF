# 服务模块测试示例

本目录包含了 `app.services` 模块的完整测试示例，用于演示和验证后端服务接口的功能。

## 文件结构

```
examples/
├── README.md                 # 本文档
├── common_example.py         # Common服务模块测试示例
├── monitor_example.py        # Monitor服务模块测试示例
└── run_all_examples.py      # 运行所有示例的脚本
```

## 快速开始

### 方法1：运行所有测试
```bash
# 在项目根目录下运行
python examples/run_all_examples.py
```

### 方法2：单独运行测试
```bash
# 测试Common模块
python examples/common_example.py

# 测试Monitor模块  
python examples/monitor_example.py
```

## 测试内容

### common_example.py - Common服务模块测试

测试 `app.services.common` 模块的以下功能：

1. **模型注册器测试**
   - 注册模型
   - 列出已注册模型
   - 获取特定模型信息
   - 更新模型状态

2. **系统信息获取**
   - 获取操作系统信息
   - 获取Python和PyTorch版本
   - 检查CUDA可用性

3. **资源监控功能**
   - CPU使用率监控
   - 内存使用情况
   - GPU信息获取（如果可用）

4. **模型统计信息**
   - 创建测试模型
   - 计算参数量和模型大小
   - 获取层级信息

5. **流式资源监控**
   - 实时监控系统资源
   - 演示数据流式更新

6. **模型加载功能**
   - 测试模型保存和加载
   - 错误处理验证

### monitor_example.py - Monitor服务模块测试

测试 `app.services.monitor` 模块的以下功能：

1. **ModelMonitor基本功能**
   - 创建监控器
   - 启动和停止监控
   - 性能数据收集

2. **特征图功能**
   - 模拟特征图生成
   - 真实模型特征图提取
   - 钩子注册和清理

3. **完整监控工作流程**
   - 模型注册
   - 监控启动
   - 状态检查
   - 监控停止

4. **推理统计功能**
   - 推理时间测量
   - 吞吐量计算
   - 性能指标统计

5. **运行时间计算**
   - 不同时间间隔测试
   - 格式化输出验证

6. **并发监控测试**
   - 多模型同时监控
   - 线程安全验证

7. **错误处理测试**
   - 异常情况处理
   - 边界条件测试

8. **性能基准测试**
   - 监控器创建速度
   - 特征图生成性能
   - 数据收集效率

## 运行要求

### 必需依赖
- Python 3.7+
- PyTorch
- psutil
- numpy

### 可选依赖
- pynvml（用于详细GPU信息）
- CUDA（用于GPU功能测试）

## 预期输出

运行测试时，您将看到：

1. **详细的功能测试报告**
   - 每个功能的测试结果
   - 性能指标输出
   - 错误信息（如果有）

2. **系统信息输出**
   - 硬件配置信息
   - 资源使用情况
   - GPU状态（如果可用）

3. **模型监控数据**
   - 模拟的性能指标
   - 特征图可视化信息
   - 监控状态变化

## 故障排除

### 常见问题

1. **ImportError: No module named 'app.services'**
   - 确保在项目根目录运行脚本
   - 检查 Python 路径设置

2. **GPU相关错误**
   - 如果没有GPU，GPU测试会使用模拟数据
   - 安装 pynvml 获取更详细的GPU信息

3. **权限错误**
   - 确保有文件写入权限（用于临时模型文件）
   - 某些系统监控功能可能需要管理员权限

### 调试模式

如果测试失败，可以单独运行特定测试函数：

```python
# 在common_example.py中
if __name__ == "__main__":
    # 只运行特定测试
    test_model_registry()
```

## 开发者注意事项

### 添加新测试

1. 在相应的示例文件中添加新的测试函数
2. 在 `main()` 函数中调用新测试
3. 更新此文档的测试内容列表

### 测试数据

- 所有测试使用模拟数据，不依赖真实模型文件
- 临时文件会在测试后自动清理
- 监控测试使用短时间间隔以加快执行

### 性能考虑

- 测试设计为在几分钟内完成
- 并发测试使用较少的线程数
- 流式监控测试时间有限制

## 贡献

如果您发现测试问题或想要添加新的测试用例，请：

1. 检查现有测试是否覆盖了相关功能
2. 遵循现有的测试模式和命名约定
3. 确保新测试具有适当的错误处理
4. 更新相关文档 